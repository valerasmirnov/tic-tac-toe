<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏</title>

  <style>
    :root{
      --text:#e9edf1;
      --muted:#a8b0bb;
      --cell:#1c2130;
      --cellActive:#262d42;
      --border:rgba(255,255,255,.12);
      --radius:18px;
      --x:#ff3b30;
      --o:#4da3ff;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

    body{
      margin:0;
      min-height:100dvh;
      background:linear-gradient(180deg,#0b0c10,#0f1220);
      color:var(--text);
      font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      display:flex;
      justify-content:center;
      padding:env(safe-area-inset-top) 16px env(safe-area-inset-bottom);
    }

    .app{
      width:min(520px,100%);
      display:flex;
      flex-direction:column;
      gap:14px;
      padding:16px 0 24px;
    }

    header{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
    }

    h1{ margin:0; font-size:22px; letter-spacing:.2px; }
    .sub{ margin:4px 0 0; font-size:14px; color:var(--muted); }

    .pill{
      padding:8px 12px;
      border:1px solid var(--border);
      border-radius:999px;
      background:rgba(255,255,255,.04);
      font-size:14px;
      white-space:nowrap;
    }

    .markX{ color:var(--x); font-weight:900; }
    .markO{ color:var(--o); font-weight:900; }

    .board{
      width:100%;
      aspect-ratio:1/1;
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:10px;
      padding:12px;
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius:var(--radius);
    }

    .cell{
      width:100%;
      aspect-ratio:1/1;
      display:flex;
      align-items:center;
      justify-content:center;
      background:var(--cell);
      border:1px solid var(--border);
      border-radius:16px;
      font-size:clamp(44px,10vw,72px);
      font-weight:900;
      line-height:1;
      cursor:pointer;
      user-select:none;
      transition:background .12s ease, box-shadow .2s ease, border-color .2s ease;
      touch-action:manipulation;
    }
    .cell:active{ background:var(--cellActive); }

    .cell.x{ color:var(--x); }
    .cell.o{ color:var(--o); }

    .cell.win{
      border-color: rgba(122,162,255,.65);
      box-shadow: 0 0 0 2px rgba(122,162,255,.25), 0 0 28px rgba(122,162,255,.18);
    }

    @keyframes pop {
      0%   { transform: scale(.86); opacity: 0; }
      60%  { transform: scale(1.08); opacity: 1; }
      100% { transform: scale(1); }
    }
    .cell.pop{ animation: pop 180ms ease-out; }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    button{
      flex:1;
      min-width:160px;
      padding:12px 14px;
      font-size:16px;
      font-weight:800;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.08);
      color:var(--text);
      cursor:pointer;
      transition:background .12s ease;
      touch-action:manipulation;
    }
    button:active{ background:rgba(255,255,255,.12); }

    .primary{
      background:rgba(122,162,255,.22);
      border-color:rgba(122,162,255,.35);
    }
    .primary:active{ background:rgba(122,162,255,.28); }

    .overlay{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      background:rgba(0,0,0,.55);
      backdrop-filter:blur(6px);
      z-index:999;
    }
    .overlay[hidden]{ display:none !important; }

    .modal{
      width:min(440px,100%);
      background:rgba(21,24,34,.95);
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
    }

    .modalTitle{
      font-size:20px;
      font-weight:900;
      margin-bottom:8px;
    }

    .modalText{
      font-size:15px;
      color:var(--muted);
      margin-bottom:14px;
      line-height:1.35;
    }

    .modalBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin:10px 0 12px;
    }
    .fieldLabel{
      font-size:12px;
      color:var(--muted);
    }
    .seg{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .chip{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      cursor:pointer;
      user-select:none;
      font-weight:900;
      font-size:14px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .chip.active{
      background:rgba(122,162,255,.22);
      border-color:rgba(122,162,255,.35);
    }
    select{
      appearance:none;
      -webkit-appearance:none;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-size:14px;
      font-weight:800;
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div>
        <h1>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏</h1>
        <p class="sub" id="subtitle">–í—ã–±–µ—Ä–∏ —Ä–µ–∂–∏–º –≤ –º–µ–Ω—é</p>
      </div>
      <div class="pill" id="score"><span class="markX">X</span> 0 : 0 <span class="markO">O</span></div>
    </header>

    <div class="board" id="board" aria-label="–ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ 3 –Ω–∞ 3"></div>

    <div class="row">
      <button class="primary" id="newGameBtn">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
      <button id="resetScoreBtn">–°–±—Ä–æ—Å–∏—Ç—å —Å—á—ë—Ç</button>
    </div>
  </div>

  <!-- –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω -->
  <div class="overlay" id="startOverlay" hidden>
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="startTitle">
      <div class="modalTitle" id="startTitle">–°—Ç–∞—Ä—Ç</div>
      <div class="modalText">–í—ã–±–µ—Ä–∏ —Ä–µ–∂–∏–º –∏ –∑–∞ –∫–æ–≥–æ –∏–≥—Ä–∞–µ—à—å.</div>

      <div class="field">
        <div class="fieldLabel">–†–µ–∂–∏–º</div>
        <div class="seg">
          <div class="chip active" data-mode="pvp" id="modePvp">üë• –î–≤–∞ –∏–≥—Ä–æ–∫–∞</div>
          <div class="chip" data-mode="ai" id="modeAi">ü§ñ –ü—Ä–æ—Ç–∏–≤ –ò–ò</div>
        </div>
      </div>

      <div class="field" id="sideField">
        <div class="fieldLabel">–¢—ã –∏–≥—Ä–∞–µ—à—å –∑–∞</div>
        <div class="seg">
          <div class="chip active" data-side="X" id="sideX"><span class="markX">X</span></div>
          <div class="chip" data-side="O" id="sideO"><span class="markO">O</span></div>
        </div>
      </div>

      <div class="field" id="difficultyField" style="display:none;">
        <div class="fieldLabel">–°–ª–æ–∂–Ω–æ—Å—Ç—å –ò–ò</div>
        <select id="difficulty">
          <option value="easy">–õ—ë–≥–∫–∞—è</option>
          <option value="medium">–°—Ä–µ–¥–Ω—è—è</option>
          <option value="hard">–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤—ã–∏–≥—Ä–∞—Ç—å</option>
        </select>
      </div>

      <div class="modalBtns">
        <button class="primary" id="startBtn">–ù–∞—á–∞—Ç—å</button>
        <button id="closeStartBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –û–∫–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
  <div class="overlay" id="resultOverlay" hidden>
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="resultTitle">
      <div class="modalTitle" id="resultTitle">–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞</div>
      <div class="modalText" id="resultText"></div>
      <div class="modalBtns">
        <button class="primary" id="playAgainBtn">–ò–≥—Ä–∞—Ç—å –µ—â—ë</button>
        <button id="closeResultBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    const boardEl = document.getElementById('board');
    const subtitleEl = document.getElementById('subtitle');
    const scoreEl = document.getElementById('score');

    const newGameBtn = document.getElementById('newGameBtn');
    const resetScoreBtn = document.getElementById('resetScoreBtn');

    const startOverlay = document.getElementById('startOverlay');
    const modePvp = document.getElementById('modePvp');
    const modeAi = document.getElementById('modeAi');
    const sideField = document.getElementById('sideField');
    const difficultyField = document.getElementById('difficultyField');
    const difficultyEl = document.getElementById('difficulty');

    const sideX = document.getElementById('sideX');
    const sideO = document.getElementById('sideO');

    const startBtn = document.getElementById('startBtn');
    const closeStartBtn = document.getElementById('closeStartBtn');

    const resultOverlay = document.getElementById('resultOverlay');
    const resultTitle = document.getElementById('resultTitle');
    const resultText = document.getElementById('resultText');
    const playAgainBtn = document.getElementById('playAgainBtn');
    const closeResultBtn = document.getElementById('closeResultBtn');

    const X = 'X';
    const O = 'O';

    const wins = [
      [0,1,2],[3,4,5],[6,7,8],
      [0,3,6],[1,4,7],[2,5,8],
      [0,4,8],[2,4,6]
    ];

    let mode = 'pvp';
    let human = X;
    let ai = O;
    let difficulty = 'easy';

    let current = X;
    let cells = Array(9).fill(null);
    let gameOver = false;
    let winningLine = null;
    let lastMove = null;

    let scoreX = 0;
    let scoreO = 0;

    let endTimer = null;

    function markHTML(p){
      return p === X ? '<span class="markX">X</span>' : '<span class="markO">O</span>';
    }
    function updateScore(){
      scoreEl.innerHTML = `${markHTML(X)} ${scoreX} : ${scoreO} ${markHTML(O)}`;
    }
    function clearEndTimer(){
      if (endTimer){ clearTimeout(endTimer); endTimer = null; }
    }
    function setSubtitleTurn(){
      if (gameOver) return;
      if (mode === 'ai'){
        const suffix = (current === ai) ? ' <span style="color:var(--muted); font-size:12px;">(–ò–ò)</span>' : '';
        subtitleEl.innerHTML = `–•–æ–¥: ${markHTML(current)}${suffix}`;
      } else {
        subtitleEl.innerHTML = `–•–æ–¥: ${markHTML(current)}`;
      }
    }

    function showStartOverlay(){ startOverlay.hidden = false; }
    function hideStartOverlay(){ startOverlay.hidden = true; }
    function showResultOverlay(title, html){
      resultTitle.textContent = title;
      resultText.innerHTML = html;
      resultOverlay.hidden = false;
    }
    function hideResultOverlay(){ resultOverlay.hidden = true; }

    function render(){
      boardEl.innerHTML = '';
      cells.forEach((v,i)=>{
        const c = document.createElement('div');
        c.className = 'cell';
        c.textContent = v || '';
        c.classList.toggle('x', v === X);
        c.classList.toggle('o', v === O);
        if (winningLine && winningLine.includes(i)) c.classList.add('win');
        if (lastMove === i && v) c.classList.add('pop');
        c.addEventListener('click', () => onCellClick(i));
        boardEl.appendChild(c);
      });
    }

    function checkWinner(){
      for (const [a,b,c] of wins){
        if (cells[a] && cells[a] === cells[b] && cells[a] === cells[c]){
          return { winner: cells[a], line: [a,b,c] };
        }
      }
      return cells.includes(null) ? null : { winner:'draw', line:null };
    }

    function finishGame(res){
      gameOver = true;
      winningLine = res.line;
      render();

      clearEndTimer();
      endTimer = setTimeout(() => {
        if (res.winner === 'draw'){
          subtitleEl.textContent = '–ù–∏—á—å—è ü§ù';
          showResultOverlay('–ù–∏—á—å—è ü§ù', '–°–∏–ª—å–Ω–∞—è –ø–∞—Ä—Ç–∏—è. –°—ã–≥—Ä–∞–µ–º –µ—â—ë?');
        } else {
          if (res.winner === X) scoreX++;
          if (res.winner === O) scoreO++;
          updateScore();
          subtitleEl.innerHTML = `–ü–æ–±–µ–¥–∏–ª ${markHTML(res.winner)} üéâ`;
          showResultOverlay('–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞ üéâ', `–ü–æ–±–µ–¥–∏–ª ${markHTML(res.winner)}`);
        }
      }, 2000);
    }

    function place(i, player){
      cells[i] = player;
      lastMove = i;
      render();
    }

    function onCellClick(i){
      if (gameOver || cells[i]) return;
      if (mode === 'ai' && current === ai) return;

      place(i, current);

      const res = checkWinner();
      if (res) return finishGame(res);

      current = (current === X) ? O : X;
      setSubtitleTurn();

      if (mode === 'ai' && current === ai){
        setTimeout(aiTurn, 250);
      }
    }

    // ===== AI =====
    function aiTurn(){
      if (mode !== 'ai' || gameOver || current !== ai) return;

      let move = null;
      if (difficulty === 'easy'){
        move = randomMove(cells);
      } else if (difficulty === 'medium'){
        move = mediumMove(cells, ai, human);
      } else {
        move = bestMoveMinimax(cells, ai).index;
      }

      if (move == null) return;

      place(move, ai);

      const res = checkWinner();
      if (res) return finishGame(res);

      current = human;
      setSubtitleTurn();
    }

    function randomMove(board){
      const empty = [];
      for (let i=0;i<9;i++) if (!board[i]) empty.push(i);
      if (!empty.length) return null;
      return empty[Math.floor(Math.random()*empty.length)];
    }

    // –°—Ä–µ–¥–Ω–∏–π: win-in-1, block-in-1, –∏–Ω–∞—á–µ "—É–º–Ω—ã–π" –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç + –Ω–µ–º–Ω–æ–≥–æ —Ä–∞–Ω–¥–æ–º–∞
    function mediumMove(board, aiP, humanP){
      const win = findImmediateWin(board, aiP);
      if (win != null) return win;

      const block = findImmediateWin(board, humanP);
      if (block != null) return block;

      // 70% ‚Äî "—É–º–Ω—ã–π" –≤—ã–±–æ—Ä, 30% ‚Äî —Å–ª—É—á–∞–π–Ω—ã–π (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª –∏–¥–µ–∞–ª—å–Ω—ã–º)
      if (Math.random() < 0.7){
        const pref = preferredMove(board);
        if (pref != null) return pref;
      }
      return randomMove(board);
    }

    function findImmediateWin(board, player){
      for (let i=0;i<9;i++){
        if (board[i]) continue;
        board[i] = player;
        const w = winnerOn(board);
        board[i] = null;
        if (w === player) return i;
      }
      return null;
    }

    function preferredMove(board){
      // —Ü–µ–Ω—Ç—Ä ‚Üí —É–≥–ª—ã ‚Üí —Å—Ç–æ—Ä–æ–Ω—ã
      const order = [4,0,2,6,8,1,3,5,7];
      for (const i of order){
        if (!board[i]) return i;
      }
      return null;
    }

    function winnerOn(board){
      for (const [a,b,c] of wins){
        if (board[a] && board[a] === board[b] && board[a] === board[c]) return board[a];
      }
      return board.includes(null) ? null : 'draw';
    }

    // Minimax (hard)
    function bestMoveMinimax(board, player){
      return minimax(board.slice(), player);
    }
    function minimax(b, player){
      const t = winnerOn(b);
      if (t){
        if (t === ai) return { score: 10 };
        if (t === human) return { score: -10 };
        return { score: 0 };
      }

      const empty = [];
      for (let i=0;i<9;i++) if (!b[i]) empty.push(i);

      const moves = [];
      for (const idx of empty){
        b[idx] = player;
        const next = minimax(b, player === X ? O : X);
        moves.push({ index: idx, score: next.score });
        b[idx] = null;
      }

      const wantMax = (player === ai);
      let best = moves[0];
      for (const m of moves){
        if (wantMax){
          if (m.score > best.score) best = m;
        } else {
          if (m.score < best.score) best = m;
        }
      }
      return best;
    }

    // ===== Start / Reset =====
    function resetBoard(){
      clearEndTimer();
      hideResultOverlay();
      cells = Array(9).fill(null);
      gameOver = false;
      winningLine = null;
      lastMove = null;
      render();
    }

    function startGame(){
      resetBoard();

      if (mode === 'ai'){
        ai = (human === X) ? O : X;
        current = X; // –≤—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç X
        hideStartOverlay();

        // –µ—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –≤—ã–±—Ä–∞–ª O ‚Äî –ò–ò –∑–∞ X —Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—ã–º
        if (human === O){
          current = ai; // X
          setSubtitleTurn();
          setTimeout(aiTurn, 250);
        } else {
          current = human; // X
          setSubtitleTurn();
        }
      } else {
        current = X;
        hideStartOverlay();
        setSubtitleTurn();
      }
    }

    function setMode(next){
      mode = next;
      modePvp.classList.toggle('active', mode === 'pvp');
      modeAi.classList.toggle('active', mode === 'ai');
      sideField.style.display = (mode === 'ai') ? '' : 'none';
      difficultyField.style.display = (mode === 'ai') ? '' : 'none';
    }

    function setSide(next){
      human = next;
      sideX.classList.toggle('active', human === X);
      sideO.classList.toggle('active', human === O);
    }

    modePvp.addEventListener('click', () => setMode('pvp'));
    modeAi.addEventListener('click', () => setMode('ai'));
    sideX.addEventListener('click', () => setSide(X));
    sideO.addEventListener('click', () => setSide(O));
    difficultyEl.addEventListener('change', () => difficulty = difficultyEl.value);

    startBtn.addEventListener('click', startGame);

    closeStartBtn.addEventListener('click', () => {
      startOverlay.hidden = true;
      if (!cells.some(v => v) && scoreX === 0 && scoreO === 0) startOverlay.hidden = false;
    });

    newGameBtn.addEventListener('click', () => {
      hideResultOverlay();
      showStartOverlay();
    });

    resetScoreBtn.addEventListener('click', () => {
      scoreX = 0; scoreO = 0;
      updateScore();
      hideResultOverlay();
      showStartOverlay();
    });

    playAgainBtn.addEventListener('click', () => {
      hideResultOverlay();
      startGame();
    });

    closeResultBtn.addEventListener('click', hideResultOverlay);
    resultOverlay.addEventListener('click', (e) => { if (e.target === resultOverlay) hideResultOverlay(); });

    updateScore();
    setMode('pvp');
    setSide(X);
    difficulty = difficultyEl.value;
    render();
    showStartOverlay();
  </script>
</body>
</html>